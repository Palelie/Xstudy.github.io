(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{1194:function(s,t,a){s.exports=a.p+"assets/img/image-20210717161939695.75c5450a.png"},1195:function(s,t,a){s.exports=a.p+"assets/img/image-20210717162004285.675cd6c8.png"},1196:function(s,t,a){s.exports=a.p+"assets/img/image-20210422095356088.2de21ddd.png"},1197:function(s,t){s.exports="data:image/png;base64,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"},1198:function(s,t,a){s.exports=a.p+"assets/img/image-20210717162752376.b00101bd.png"},1199:function(s,t,a){s.exports=a.p+"assets/img/image-20210717163332646.c1e7fcc8.png"},1200:function(s,t,a){s.exports=a.p+"assets/img/image-20210717163253264.6cd34c58.png"},1201:function(s,t,a){s.exports=a.p+"assets/img/image-20210717163604330.f07729be.png"},1202:function(s,t,a){s.exports=a.p+"assets/img/image-20210717163434647.53ccff8c.png"},1203:function(s,t,a){s.exports=a.p+"assets/img/image-20210717164024967.695b4b8d.png"},1204:function(s,t,a){s.exports=a.p+"assets/img/image-20210717164038678.7e69fbeb.png"},1205:function(s,t,a){s.exports=a.p+"assets/img/image-20210717164238910.aea99599.png"},1206:function(s,t,a){s.exports=a.p+"assets/img/image-20210717165309625.f97b1e36.png"},1207:function(s,t,a){s.exports=a.p+"assets/img/image-20210717165438225.dc1debf8.png"},1208:function(s,t,a){s.exports=a.p+"assets/img/image-20210717165509466.41e56e08.png"},1209:function(s,t,a){s.exports=a.p+"assets/img/image-20210717165552676.1a27bc7f.png"},1210:function(s,t,a){s.exports=a.p+"assets/img/image-20210717170041447.262a1ae2.png"},1211:function(s,t,a){s.exports=a.p+"assets/img/image-20210717170223317.c3f75593.png"},1212:function(s,t,a){s.exports=a.p+"assets/img/image-20210717170705380.f8bc75f6.png"},1213:function(s,t,a){s.exports=a.p+"assets/img/image-20210717170829229.2fa54688.png"},1214:function(s,t,a){s.exports=a.p+"assets/img/image-20200525170410401.68eb220c.png"},1215:function(s,t,a){s.exports=a.p+"assets/img/image-20210422232835363.38e2d259.png"},1808:function(s,t,a){"use strict";a.r(t);var n=a(1),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"rabbitmq基础"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#rabbitmq基础"}},[s._v("#")]),s._v(" RabbitMQ基础")]),s._v(" "),n("h1",{attrs:{id:"_1-初识mq"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-初识mq"}},[s._v("#")]),s._v(" 1.初识MQ")]),s._v(" "),n("h2",{attrs:{id:"_1-1-同步和异步通讯"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-同步和异步通讯"}},[s._v("#")]),s._v(" 1.1.同步和异步通讯")]),s._v(" "),n("p",[s._v("微服务间通讯有同步和异步两种方式：")]),s._v(" "),n("p",[s._v("同步通讯：就像打电话，需要实时响应。")]),s._v(" "),n("p",[s._v("异步通讯：就像发邮件，不需要马上回复。")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1194),alt:"image-20210717161939695"}})]),s._v(" "),n("p",[s._v("两种方式各有优劣，打电话可以立即得到响应，但是你却不能跟多个人同时通话。发送邮件可以同时与多个人收发邮件，但是往往响应会有延迟。")]),s._v(" "),n("h3",{attrs:{id:"_1-1-1-同步通讯"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-1-同步通讯"}},[s._v("#")]),s._v(" 1.1.1.同步通讯")]),s._v(" "),n("p",[s._v("我们之前学习的Feign调用就属于同步方式，虽然调用可以实时得到结果，但存在下面的问题：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1195),alt:"image-20210717162004285"}})]),s._v(" "),n("p",[s._v("总结：")]),s._v(" "),n("p",[s._v("同步调用的优点：")]),s._v(" "),n("ul",[n("li",[s._v("时效性较强，可以立即得到结果")])]),s._v(" "),n("p",[s._v("同步调用的问题：")]),s._v(" "),n("ul",[n("li",[s._v("耦合度高")]),s._v(" "),n("li",[s._v("性能和吞吐能力下降")]),s._v(" "),n("li",[s._v("有额外的资源消耗")]),s._v(" "),n("li",[s._v("有级联失败问题")])]),s._v(" "),n("h3",{attrs:{id:"_1-1-2-异步通讯"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-2-异步通讯"}},[s._v("#")]),s._v(" 1.1.2.异步通讯")]),s._v(" "),n("p",[s._v("异步调用则可以避免上述问题：")]),s._v(" "),n("p",[s._v("我们以购买商品为例，用户支付后需要调用订单服务完成订单状态修改，调用物流服务，从仓库分配响应的库存并准备发货。")]),s._v(" "),n("p",[s._v("在事件模式中，支付服务是事件发布者（publisher），在支付完成后只需要发布一个支付成功的事件（event），事件中带上订单id。")]),s._v(" "),n("p",[s._v("订单服务和物流服务是事件订阅者（Consumer），订阅支付成功的事件，监听到事件后完成自己业务即可。")]),s._v(" "),n("p",[s._v("为了解除事件发布者与订阅者之间的耦合，两者并不是直接通信，而是有一个中间人（Broker）。发布者发布事件到Broker，不关心谁来订阅事件。订阅者从Broker订阅事件，不关心谁发来的消息。")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1196),alt:"image-20210422095356088"}})]),s._v(" "),n("p",[s._v("Broker 是一个像数据总线一样的东西，所有的服务要接收数据和发送数据都发到这个总线上，这个总线就像协议一样，让服务间的通讯变得标准和可控。")]),s._v(" "),n("p",[s._v("好处：")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("吞吐量提升：无需等待订阅者处理完成，响应更快速")])]),s._v(" "),n("li",[n("p",[s._v("故障隔离：服务没有直接调用，不存在级联失败问题")])]),s._v(" "),n("li",[n("p",[s._v("调用间没有阻塞，不会造成无效的资源占用")])]),s._v(" "),n("li",[n("p",[s._v("耦合度极低，每个服务都可以灵活插拔，可替换")])]),s._v(" "),n("li",[n("p",[s._v("流量削峰：不管发布事件的流量波动多大，都由Broker接收，订阅者可以按照自己的速度去处理事件")])])]),s._v(" "),n("p",[s._v("缺点：")]),s._v(" "),n("ul",[n("li",[s._v("架构复杂了，业务没有明显的流程线，不好管理")]),s._v(" "),n("li",[s._v("需要依赖于Broker的可靠、安全、性能")])]),s._v(" "),n("p",[s._v("好在现在开源软件或云平台上 Broker 的软件是非常成熟的，比较常见的一种就是我们今天要学习的MQ技术。")]),s._v(" "),n("h2",{attrs:{id:"_1-2-技术对比"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-技术对比"}},[s._v("#")]),s._v(" 1.2.技术对比：")]),s._v(" "),n("p",[s._v("MQ，中文是消息队列（MessageQueue），字面来看就是存放消息的队列。也就是事件驱动架构中的Broker。")]),s._v(" "),n("p",[s._v("比较常见的MQ实现：")]),s._v(" "),n("ul",[n("li",[s._v("ActiveMQ")]),s._v(" "),n("li",[s._v("RabbitMQ")]),s._v(" "),n("li",[s._v("RocketMQ")]),s._v(" "),n("li",[s._v("Kafka")])]),s._v(" "),n("p",[s._v("几种常见MQ的对比：")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th"),s._v(" "),n("th",[n("strong",[s._v("RabbitMQ")])]),s._v(" "),n("th",[n("strong",[s._v("ActiveMQ")])]),s._v(" "),n("th",[n("strong",[s._v("RocketMQ")])]),s._v(" "),n("th",[n("strong",[s._v("Kafka")])])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("公司/社区")]),s._v(" "),n("td",[s._v("Rabbit")]),s._v(" "),n("td",[s._v("Apache")]),s._v(" "),n("td",[s._v("阿里")]),s._v(" "),n("td",[s._v("Apache")])]),s._v(" "),n("tr",[n("td",[s._v("开发语言")]),s._v(" "),n("td",[s._v("Erlang")]),s._v(" "),n("td",[s._v("Java")]),s._v(" "),n("td",[s._v("Java")]),s._v(" "),n("td",[s._v("Scala&Java")])]),s._v(" "),n("tr",[n("td",[s._v("协议支持")]),s._v(" "),n("td",[s._v("AMQP，XMPP，SMTP，STOMP")]),s._v(" "),n("td",[s._v("OpenWire,STOMP，REST,XMPP,AMQP")]),s._v(" "),n("td",[s._v("自定义协议")]),s._v(" "),n("td",[s._v("自定义协议")])]),s._v(" "),n("tr",[n("td",[s._v("可用性")]),s._v(" "),n("td",[s._v("高")]),s._v(" "),n("td",[s._v("一般")]),s._v(" "),n("td",[s._v("高")]),s._v(" "),n("td",[s._v("高")])]),s._v(" "),n("tr",[n("td",[s._v("单机吞吐量")]),s._v(" "),n("td",[s._v("一般")]),s._v(" "),n("td",[s._v("差")]),s._v(" "),n("td",[s._v("高")]),s._v(" "),n("td",[s._v("非常高")])]),s._v(" "),n("tr",[n("td",[s._v("消息延迟")]),s._v(" "),n("td",[s._v("微秒级")]),s._v(" "),n("td",[s._v("毫秒级")]),s._v(" "),n("td",[s._v("毫秒级")]),s._v(" "),n("td",[s._v("毫秒以内")])]),s._v(" "),n("tr",[n("td",[s._v("消息可靠性")]),s._v(" "),n("td",[s._v("高")]),s._v(" "),n("td",[s._v("一般")]),s._v(" "),n("td",[s._v("高")]),s._v(" "),n("td",[s._v("一般")])])])]),s._v(" "),n("p",[s._v("追求可用性：Kafka、 RocketMQ 、RabbitMQ")]),s._v(" "),n("p",[s._v("追求可靠性：RabbitMQ、RocketMQ")]),s._v(" "),n("p",[s._v("追求吞吐能力：RocketMQ、Kafka")]),s._v(" "),n("p",[s._v("追求消息低延迟：RabbitMQ、Kafka")]),s._v(" "),n("h1",{attrs:{id:"_2-快速入门"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-快速入门"}},[s._v("#")]),s._v(" 2.快速入门")]),s._v(" "),n("h2",{attrs:{id:"_2-1-安装rabbitmq"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-安装rabbitmq"}},[s._v("#")]),s._v(" 2.1.安装RabbitMQ")]),s._v(" "),n("p",[s._v("安装RabbitMQ，参考课前资料：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1197),alt:"image-20210717162628635"}})]),s._v(" "),n("p",[s._v("MQ的基本结构：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1198),alt:"image-20210717162752376"}})]),s._v(" "),n("p",[s._v("RabbitMQ中的一些角色：")]),s._v(" "),n("ul",[n("li",[s._v("publisher：生产者")]),s._v(" "),n("li",[s._v("consumer：消费者")]),s._v(" "),n("li",[s._v("exchange个：交换机，负责消息路由")]),s._v(" "),n("li",[s._v("queue：队列，存储消息")]),s._v(" "),n("li",[s._v("virtualHost：虚拟主机，隔离不同租户的exchange、queue、消息的隔离")])]),s._v(" "),n("h2",{attrs:{id:"_2-2-rabbitmq消息模型"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-rabbitmq消息模型"}},[s._v("#")]),s._v(" 2.2.RabbitMQ消息模型")]),s._v(" "),n("p",[s._v("RabbitMQ官方提供了5个不同的Demo示例，对应了不同的消息模型：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1199),alt:"image-20210717163332646"}})]),s._v(" "),n("h2",{attrs:{id:"_2-3-导入demo工程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-导入demo工程"}},[s._v("#")]),s._v(" 2.3.导入Demo工程")]),s._v(" "),n("p",[s._v("课前资料提供了一个Demo工程，mq-demo:")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1200),alt:"image-20210717163253264"}})]),s._v(" "),n("p",[s._v("导入后可以看到结构如下：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1201),alt:"image-20210717163604330"}})]),s._v(" "),n("p",[s._v("包括三部分：")]),s._v(" "),n("ul",[n("li",[s._v("mq-demo：父工程，管理项目依赖")]),s._v(" "),n("li",[s._v("publisher：消息的发送者")]),s._v(" "),n("li",[s._v("consumer：消息的消费者")])]),s._v(" "),n("h2",{attrs:{id:"_2-4-入门案例"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-入门案例"}},[s._v("#")]),s._v(" 2.4.入门案例")]),s._v(" "),n("p",[s._v("简单队列模式的模型图：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1202),alt:"image-20210717163434647"}})]),s._v(" "),n("p",[s._v("官方的HelloWorld是基于最基础的消息队列模型来实现的，只包括三个角色：")]),s._v(" "),n("ul",[n("li",[s._v("publisher：消息发布者，将消息发送到队列queue")]),s._v(" "),n("li",[s._v("queue：消息队列，负责接受并缓存消息")]),s._v(" "),n("li",[s._v("consumer：订阅队列，处理队列中的消息")])]),s._v(" "),n("h3",{attrs:{id:"_2-4-1-publisher实现"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-1-publisher实现"}},[s._v("#")]),s._v(" 2.4.1.publisher实现")]),s._v(" "),n("p",[s._v("思路：")]),s._v(" "),n("ul",[n("li",[s._v("建立连接")]),s._v(" "),n("li",[s._v("创建Channel")]),s._v(" "),n("li",[s._v("声明队列")]),s._v(" "),n("li",[s._v("发送消息")]),s._v(" "),n("li",[s._v("关闭连接和channel")])]),s._v(" "),n("p",[s._v("代码实现：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("package")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("cn"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("itcast"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mq"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("helloworld")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rabbitmq"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Channel")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rabbitmq"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Connection")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rabbitmq"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ConnectionFactory")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("junit"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Test")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("java"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("io"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("IOException")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("java"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("util"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("concurrent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("TimeoutException")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("PublisherTest")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Test")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("testSendMessage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("IOException")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("TimeoutException")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 1.建立连接")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ConnectionFactory")]),s._v(" factory "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ConnectionFactory")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 1.1.设置连接参数，分别是：主机名、端口号、vhost、用户名、密码")]),s._v("\n        factory"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setHost")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"192.168.150.101"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        factory"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setPort")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5672")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        factory"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setVirtualHost")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        factory"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setUsername")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"itcast"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        factory"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setPassword")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"123321"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 1.2.建立连接")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Connection")]),s._v(" connection "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" factory"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("newConnection")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 2.创建通道Channel")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Channel")]),s._v(" channel "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" connection"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("createChannel")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 3.创建队列")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" queueName "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"simple.queue"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        channel"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("queueDeclare")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("queueName"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 4.发送消息")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" message "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello, rabbitmq!"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        channel"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("basicPublish")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" queueName"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" message"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getBytes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"发送消息成功：【"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" message "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"】"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 5.关闭通道和连接")]),s._v("\n        channel"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("close")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        connection"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("close")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br")])]),n("h3",{attrs:{id:"_2-4-2-consumer实现"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-2-consumer实现"}},[s._v("#")]),s._v(" 2.4.2.consumer实现")]),s._v(" "),n("p",[s._v("代码思路：")]),s._v(" "),n("ul",[n("li",[s._v("建立连接")]),s._v(" "),n("li",[s._v("创建Channel")]),s._v(" "),n("li",[s._v("声明队列")]),s._v(" "),n("li",[s._v("订阅消息")])]),s._v(" "),n("p",[s._v("代码实现：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("package")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("cn"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("itcast"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mq"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("helloworld")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rabbitmq"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("java"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("io"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("IOException")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("java"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("util"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("concurrent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("TimeoutException")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ConsumerTest")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" args"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("IOException")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("TimeoutException")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 1.建立连接")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ConnectionFactory")]),s._v(" factory "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ConnectionFactory")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 1.1.设置连接参数，分别是：主机名、端口号、vhost、用户名、密码")]),s._v("\n        factory"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setHost")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"192.168.150.101"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        factory"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setPort")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5672")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        factory"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setVirtualHost")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        factory"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setUsername")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"itcast"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        factory"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setPassword")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"123321"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 1.2.建立连接")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Connection")]),s._v(" connection "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" factory"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("newConnection")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 2.创建通道Channel")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Channel")]),s._v(" channel "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" connection"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("createChannel")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 3.创建队列")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" queueName "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"simple.queue"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        channel"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("queueDeclare")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("queueName"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 4.订阅消息")]),s._v("\n        channel"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("basicConsume")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("queueName"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DefaultConsumer")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("channel"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("handleDelivery")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" consumerTag"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Envelope")]),s._v(" envelope"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                       "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("AMQP"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("BasicProperties")]),s._v(" properties"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("byte")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" body"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("IOException")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 5.处理消息")]),s._v("\n                "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" message "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("body"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"接收到消息：【"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" message "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"】"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"等待接收消息。。。。"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br")])]),n("h2",{attrs:{id:"_2-5-总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-5-总结"}},[s._v("#")]),s._v(" 2.5.总结")]),s._v(" "),n("p",[s._v("基本消息队列的消息发送流程：")]),s._v(" "),n("ol",[n("li",[n("p",[s._v("建立connection")])]),s._v(" "),n("li",[n("p",[s._v("创建channel")])]),s._v(" "),n("li",[n("p",[s._v("利用channel声明队列")])]),s._v(" "),n("li",[n("p",[s._v("利用channel向队列发送消息")])])]),s._v(" "),n("p",[s._v("基本消息队列的消息接收流程：")]),s._v(" "),n("ol",[n("li",[n("p",[s._v("建立connection")])]),s._v(" "),n("li",[n("p",[s._v("创建channel")])]),s._v(" "),n("li",[n("p",[s._v("利用channel声明队列")])]),s._v(" "),n("li",[n("p",[s._v("定义consumer的消费行为handleDelivery()")])]),s._v(" "),n("li",[n("p",[s._v("利用channel将消费者与队列绑定")])])]),s._v(" "),n("h1",{attrs:{id:"_3-springamqp"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-springamqp"}},[s._v("#")]),s._v(" 3.SpringAMQP")]),s._v(" "),n("p",[s._v("SpringAMQP是基于RabbitMQ封装的一套模板，并且还利用SpringBoot对其实现了自动装配，使用起来非常方便。")]),s._v(" "),n("p",[s._v("SpringAmqp的官方地址：https://spring.io/projects/spring-amqp")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1203),alt:"image-20210717164024967"}})]),s._v(" "),n("p",[n("img",{attrs:{src:a(1204),alt:"image-20210717164038678"}})]),s._v(" "),n("p",[s._v("SpringAMQP提供了三个功能：")]),s._v(" "),n("ul",[n("li",[s._v("自动声明队列、交换机及其绑定关系")]),s._v(" "),n("li",[s._v("基于注解的监听器模式，异步接收消息")]),s._v(" "),n("li",[s._v("封装了RabbitTemplate工具，用于发送消息")])]),s._v(" "),n("h2",{attrs:{id:"_3-1-basic-queue-简单队列模型"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-basic-queue-简单队列模型"}},[s._v("#")]),s._v(" 3.1.Basic Queue 简单队列模型")]),s._v(" "),n("p",[s._v("在父工程mq-demo中引入依赖")]),s._v(" "),n("div",{staticClass:"language-xml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-xml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("\x3c!--AMQP依赖，包含RabbitMQ--\x3e")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("dependency")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("groupId")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("org.springframework.boot"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("groupId")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("artifactId")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("spring-boot-starter-amqp"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("artifactId")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("dependency")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h3",{attrs:{id:"_3-1-1-消息发送"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-1-消息发送"}},[s._v("#")]),s._v(" 3.1.1.消息发送")]),s._v(" "),n("p",[s._v("首先配置MQ地址，在publisher服务的application.yml中添加配置：")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spring")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rabbitmq")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("host")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 192.168.150.101 "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 主机名")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5672")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 端口")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("virtual-host")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" / "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 虚拟主机")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("username")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" itcast "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 用户名")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("password")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("123321")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 密码")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("然后在publisher服务中编写测试类SpringAmqpTest，并利用RabbitTemplate实现消息发送：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("package")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("cn"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("itcast"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mq"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("spring")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("junit"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Test")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("junit"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("runner"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RunWith")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("amqp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rabbit"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("core"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RabbitTemplate")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("beans"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("factory"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("annotation"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Autowired")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("boot"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("test"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SpringBootTest")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("test"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("junit4"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SpringRunner")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@RunWith")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SpringRunner")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@SpringBootTest")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SpringAmqpTest")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Autowired")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RabbitTemplate")]),s._v(" rabbitTemplate"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Test")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("testSimpleQueue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 队列名称")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" queueName "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"simple.queue"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 消息")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" message "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello, spring amqp!"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 发送消息")]),s._v("\n        rabbitTemplate"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("convertAndSend")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("queueName"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" message"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br")])]),n("h3",{attrs:{id:"_3-1-2-消息接收"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-2-消息接收"}},[s._v("#")]),s._v(" 3.1.2.消息接收")]),s._v(" "),n("p",[s._v("首先配置MQ地址，在consumer服务的application.yml中添加配置：")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spring")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rabbitmq")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("host")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 192.168.150.101 "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 主机名")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5672")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 端口")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("virtual-host")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" / "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 虚拟主机")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("username")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" itcast "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 用户名")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("password")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("123321")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 密码")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("然后在consumer服务的"),n("code",[s._v("cn.itcast.mq.listener")]),s._v("包中新建一个类SpringRabbitListener，代码如下：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("package")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("cn"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("itcast"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mq"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("listener")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("amqp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rabbit"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("annotation"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RabbitListener")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("stereotype"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Component")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Component")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SpringRabbitListener")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@RabbitListener")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("queues "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"simple.queue"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("listenSimpleQueueMessage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" msg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("InterruptedException")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"spring 消费者接收到消息：【"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" msg "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"】"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])]),n("h3",{attrs:{id:"_3-1-3-测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-3-测试"}},[s._v("#")]),s._v(" 3.1.3.测试")]),s._v(" "),n("p",[s._v("启动consumer服务，然后在publisher服务中运行测试代码，发送MQ消息")]),s._v(" "),n("h2",{attrs:{id:"_3-2-workqueue"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-workqueue"}},[s._v("#")]),s._v(" 3.2.WorkQueue")]),s._v(" "),n("p",[s._v("Work queues，也被称为（Task queues），任务模型。简单来说就是"),n("strong",[s._v("让多个消费者绑定到一个队列，共同消费队列中的消息")]),s._v("。")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1205),alt:"image-20210717164238910"}})]),s._v(" "),n("p",[s._v("当消息处理比较耗时的时候，可能生产消息的速度会远远大于消息的消费速度。长此以往，消息就会堆积越来越多，无法及时处理。")]),s._v(" "),n("p",[s._v("此时就可以使用work 模型，多个消费者共同处理消息处理，速度就能大大提高了。")]),s._v(" "),n("h3",{attrs:{id:"_3-2-1-消息发送"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-1-消息发送"}},[s._v("#")]),s._v(" 3.2.1.消息发送")]),s._v(" "),n("p",[s._v("这次我们循环发送，模拟大量消息堆积现象。")]),s._v(" "),n("p",[s._v("在publisher服务中的SpringAmqpTest类中添加一个测试方法：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n     * workQueue\n     * 向队列中不停发送消息，模拟消息堆积。\n     */")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Test")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("testWorkQueue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("InterruptedException")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 队列名称")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" queueName "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"simple.queue"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 消息")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" message "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello, message_"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 发送消息")]),s._v("\n        rabbitTemplate"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("convertAndSend")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("queueName"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" message "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("h3",{attrs:{id:"_3-2-2-消息接收"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-2-消息接收"}},[s._v("#")]),s._v(" 3.2.2.消息接收")]),s._v(" "),n("p",[s._v("要模拟多个消费者绑定同一个队列，我们在consumer服务的SpringRabbitListener中添加2个新的方法：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@RabbitListener")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("queues "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"simple.queue"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("listenWorkQueue1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" msg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("InterruptedException")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"消费者1接收到消息：【"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" msg "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"】"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("LocalTime")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("now")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@RabbitListener")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("queues "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"simple.queue"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("listenWorkQueue2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" msg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("InterruptedException")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"消费者2........接收到消息：【"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" msg "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"】"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("LocalTime")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("now")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[s._v("注意到这个消费者sleep了1000秒，模拟任务耗时。")]),s._v(" "),n("h3",{attrs:{id:"_3-2-3-测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-3-测试"}},[s._v("#")]),s._v(" 3.2.3.测试")]),s._v(" "),n("p",[s._v("启动ConsumerApplication后，在执行publisher服务中刚刚编写的发送测试方法testWorkQueue。")]),s._v(" "),n("p",[s._v("可以看到消费者1很快完成了自己的25条消息。消费者2却在缓慢的处理自己的25条消息。")]),s._v(" "),n("p",[s._v("也就是说消息是平均分配给每个消费者，并没有考虑到消费者的处理能力。这样显然是有问题的。")]),s._v(" "),n("h3",{attrs:{id:"_3-2-4-能者多劳"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-4-能者多劳"}},[s._v("#")]),s._v(" 3.2.4.能者多劳")]),s._v(" "),n("p",[s._v("在spring中有一个简单的配置，可以解决这个问题。我们修改consumer服务的application.yml文件，添加配置：")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spring")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rabbitmq")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("listener")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("simple")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("prefetch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 每次只能获取一条消息，处理完成才能获取下一个消息")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h3",{attrs:{id:"_3-2-5-总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-5-总结"}},[s._v("#")]),s._v(" 3.2.5.总结")]),s._v(" "),n("p",[s._v("Work模型的使用：")]),s._v(" "),n("ul",[n("li",[s._v("多个消费者绑定到一个队列，同一条消息只会被一个消费者处理")]),s._v(" "),n("li",[s._v("通过设置prefetch来控制消费者预取的消息数量")])]),s._v(" "),n("h2",{attrs:{id:"_3-3-发布-订阅"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-发布-订阅"}},[s._v("#")]),s._v(" 3.3.发布/订阅")]),s._v(" "),n("p",[s._v("发布订阅的模型如图：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1206),alt:"image-20210717165309625"}})]),s._v(" "),n("p",[s._v("可以看到，在订阅模型中，多了一个exchange角色，而且过程略有变化：")]),s._v(" "),n("ul",[n("li",[s._v("Publisher：生产者，也就是要发送消息的程序，但是不再发送到队列中，而是发给X（交换机）")]),s._v(" "),n("li",[s._v("Exchange：交换机，图中的X。一方面，接收生产者发送的消息。另一方面，知道如何处理消息，例如递交给某个特别队列、递交给所有队列、或是将消息丢弃。到底如何操作，取决于Exchange的类型。Exchange有以下3种类型：\n"),n("ul",[n("li",[s._v("Fanout：广播，将消息交给所有绑定到交换机的队列")]),s._v(" "),n("li",[s._v("Direct：定向，把消息交给符合指定routing key 的队列")]),s._v(" "),n("li",[s._v("Topic：通配符，把消息交给符合routing pattern（路由模式） 的队列")])])]),s._v(" "),n("li",[s._v("Consumer：消费者，与以前一样，订阅队列，没有变化")]),s._v(" "),n("li",[s._v("Queue：消息队列也与以前一样，接收消息、缓存消息。")])]),s._v(" "),n("p",[n("strong",[s._v("Exchange（交换机）只负责转发消息，不具备存储消息的能力")]),s._v("，因此如果没有任何队列与Exchange绑定，或者没有符合路由规则的队列，那么消息会丢失！")]),s._v(" "),n("h2",{attrs:{id:"_3-4-fanout"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-fanout"}},[s._v("#")]),s._v(" 3.4.Fanout")]),s._v(" "),n("p",[s._v("Fanout，英文翻译是扇出，我觉得在MQ中叫广播更合适。")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1207),alt:"image-20210717165438225"}})]),s._v(" "),n("p",[s._v("在广播模式下，消息发送流程是这样的：")]),s._v(" "),n("ul",[n("li",[s._v("1）  可以有多个队列")]),s._v(" "),n("li",[s._v("2）  每个队列都要绑定到Exchange（交换机）")]),s._v(" "),n("li",[s._v("3）  生产者发送的消息，只能发送到交换机，交换机来决定要发给哪个队列，生产者无法决定")]),s._v(" "),n("li",[s._v("4）  交换机把消息发送给绑定过的所有队列")]),s._v(" "),n("li",[s._v("5）  订阅队列的消费者都能拿到消息")])]),s._v(" "),n("p",[s._v("我们的计划是这样的：")]),s._v(" "),n("ul",[n("li",[s._v("创建一个交换机 itcast.fanout，类型是Fanout")]),s._v(" "),n("li",[s._v("创建两个队列fanout.queue1和fanout.queue2，绑定到交换机itcast.fanout")])]),s._v(" "),n("p",[n("img",{attrs:{src:a(1208),alt:"image-20210717165509466"}})]),s._v(" "),n("h3",{attrs:{id:"_3-4-1-声明队列和交换机"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-1-声明队列和交换机"}},[s._v("#")]),s._v(" 3.4.1.声明队列和交换机")]),s._v(" "),n("p",[s._v("Spring提供了一个接口Exchange，来表示所有不同类型的交换机：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1209),alt:"image-20210717165552676"}})]),s._v(" "),n("p",[s._v("在consumer中创建一个类，声明队列和交换机：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("package")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("cn"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("itcast"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mq"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("config")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("amqp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("core"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Binding")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("amqp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("core"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BindingBuilder")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("amqp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("core"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("FanoutExchange")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("amqp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("core"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Queue")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("annotation"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Bean")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("annotation"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Configuration")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Configuration")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("FanoutConfig")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n     * 声明交换机\n     * @return Fanout类型交换机\n     */")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("FanoutExchange")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("fanoutExchange")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("FanoutExchange")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"itcast.fanout"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n     * 第1个队列\n     */")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Queue")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("fanoutQueue1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Queue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"fanout.queue1"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n     * 绑定队列和交换机\n     */")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Binding")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("bindingQueue1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Queue")]),s._v(" fanoutQueue1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("FanoutExchange")]),s._v(" fanoutExchange"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BindingBuilder")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("bind")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("fanoutQueue1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("fanoutExchange"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n     * 第2个队列\n     */")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Queue")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("fanoutQueue2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Queue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"fanout.queue2"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n     * 绑定队列和交换机\n     */")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Binding")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("bindingQueue2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Queue")]),s._v(" fanoutQueue2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("FanoutExchange")]),s._v(" fanoutExchange"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BindingBuilder")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("bind")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("fanoutQueue2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("fanoutExchange"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br")])]),n("h3",{attrs:{id:"_3-4-2-消息发送"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-2-消息发送"}},[s._v("#")]),s._v(" 3.4.2.消息发送")]),s._v(" "),n("p",[s._v("在publisher服务的SpringAmqpTest类中添加测试方法：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Test")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("testFanoutExchange")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 队列名称")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" exchangeName "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"itcast.fanout"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 消息")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" message "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello, everyone!"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    rabbitTemplate"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("convertAndSend")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("exchangeName"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" message"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("h3",{attrs:{id:"_3-4-3-消息接收"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-3-消息接收"}},[s._v("#")]),s._v(" 3.4.3.消息接收")]),s._v(" "),n("p",[s._v("在consumer服务的SpringRabbitListener中添加两个方法，作为消费者：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@RabbitListener")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("queues "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"fanout.queue1"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("listenFanoutQueue1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" msg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"消费者1接收到Fanout消息：【"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" msg "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"】"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@RabbitListener")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("queues "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"fanout.queue2"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("listenFanoutQueue2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" msg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"消费者2接收到Fanout消息：【"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" msg "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"】"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("h3",{attrs:{id:"_3-4-4-总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-4-总结"}},[s._v("#")]),s._v(" 3.4.4.总结")]),s._v(" "),n("p",[s._v("交换机的作用是什么？")]),s._v(" "),n("ul",[n("li",[s._v("接收publisher发送的消息")]),s._v(" "),n("li",[s._v("将消息按照规则路由到与之绑定的队列")]),s._v(" "),n("li",[s._v("不能缓存消息，路由失败，消息丢失")]),s._v(" "),n("li",[s._v("FanoutExchange的会将消息路由到每个绑定的队列")])]),s._v(" "),n("p",[s._v("声明队列、交换机、绑定关系的Bean是什么？")]),s._v(" "),n("ul",[n("li",[s._v("Queue")]),s._v(" "),n("li",[s._v("FanoutExchange")]),s._v(" "),n("li",[s._v("Binding")])]),s._v(" "),n("h2",{attrs:{id:"_3-5-direct"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-direct"}},[s._v("#")]),s._v(" 3.5.Direct")]),s._v(" "),n("p",[s._v("在Fanout模式中，一条消息，会被所有订阅的队列都消费。但是，在某些场景下，我们希望不同的消息被不同的队列消费。这时就要用到Direct类型的Exchange。")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1210),alt:"image-20210717170041447"}})]),s._v(" "),n("p",[s._v("在Direct模型下：")]),s._v(" "),n("ul",[n("li",[s._v("队列与交换机的绑定，不能是任意绑定了，而是要指定一个"),n("code",[s._v("RoutingKey")]),s._v("（路由key）")]),s._v(" "),n("li",[s._v("消息的发送方在 向 Exchange发送消息时，也必须指定消息的 "),n("code",[s._v("RoutingKey")]),s._v("。")]),s._v(" "),n("li",[s._v("Exchange不再把消息交给每一个绑定的队列，而是根据消息的"),n("code",[s._v("Routing Key")]),s._v("进行判断，只有队列的"),n("code",[s._v("Routingkey")]),s._v("与消息的 "),n("code",[s._v("Routing key")]),s._v("完全一致，才会接收到消息")])]),s._v(" "),n("p",[n("strong",[s._v("案例需求如下")]),s._v("：")]),s._v(" "),n("ol",[n("li",[n("p",[s._v("利用@RabbitListener声明Exchange、Queue、RoutingKey")])]),s._v(" "),n("li",[n("p",[s._v("在consumer服务中，编写两个消费者方法，分别监听direct.queue1和direct.queue2")])]),s._v(" "),n("li",[n("p",[s._v("在publisher中编写测试方法，向itcast. direct发送消息")])])]),s._v(" "),n("p",[n("img",{attrs:{src:a(1211),alt:"image-20210717170223317"}})]),s._v(" "),n("h3",{attrs:{id:"_3-5-1-基于注解声明队列和交换机"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-1-基于注解声明队列和交换机"}},[s._v("#")]),s._v(" 3.5.1.基于注解声明队列和交换机")]),s._v(" "),n("p",[s._v("基于@Bean的方式声明队列和交换机比较麻烦，Spring还提供了基于注解方式来声明。")]),s._v(" "),n("p",[s._v("在consumer的SpringRabbitListener中添加两个消费者，同时基于注解来声明队列和交换机：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@RabbitListener")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bindings "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@QueueBinding")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    value "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Queue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"direct.queue1"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    exchange "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Exchange")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"itcast.direct"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" type "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ExchangeTypes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("DIRECT")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    key "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"red"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"blue"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("listenDirectQueue1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" msg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"消费者接收到direct.queue1的消息：【"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" msg "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"】"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@RabbitListener")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bindings "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@QueueBinding")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    value "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Queue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"direct.queue2"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    exchange "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Exchange")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"itcast.direct"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" type "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ExchangeTypes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("DIRECT")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    key "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"red"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"yellow"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("listenDirectQueue2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" msg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"消费者接收到direct.queue2的消息：【"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" msg "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"】"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])]),n("h3",{attrs:{id:"_3-5-2-消息发送"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-2-消息发送"}},[s._v("#")]),s._v(" 3.5.2.消息发送")]),s._v(" "),n("p",[s._v("在publisher服务的SpringAmqpTest类中添加测试方法：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Test")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("testSendDirectExchange")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 交换机名称")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" exchangeName "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"itcast.direct"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 消息")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" message "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"红色警报！日本乱排核废水，导致海洋生物变异，惊现哥斯拉！"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 发送消息")]),s._v("\n    rabbitTemplate"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("convertAndSend")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("exchangeName"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"red"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" message"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("h3",{attrs:{id:"_3-5-3-总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-3-总结"}},[s._v("#")]),s._v(" 3.5.3.总结")]),s._v(" "),n("p",[s._v("描述下Direct交换机与Fanout交换机的差异？")]),s._v(" "),n("ul",[n("li",[s._v("Fanout交换机将消息路由给每一个与之绑定的队列")]),s._v(" "),n("li",[s._v("Direct交换机根据RoutingKey判断路由给哪个队列")]),s._v(" "),n("li",[s._v("如果多个队列具有相同的RoutingKey，则与Fanout功能类似")])]),s._v(" "),n("p",[s._v("基于@RabbitListener注解声明队列和交换机有哪些常见注解？")]),s._v(" "),n("ul",[n("li",[s._v("@Queue")]),s._v(" "),n("li",[s._v("@Exchange")])]),s._v(" "),n("h2",{attrs:{id:"_3-6-topic"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-6-topic"}},[s._v("#")]),s._v(" 3.6.Topic")]),s._v(" "),n("h3",{attrs:{id:"_3-6-1-说明"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-6-1-说明"}},[s._v("#")]),s._v(" 3.6.1.说明")]),s._v(" "),n("p",[n("code",[s._v("Topic")]),s._v("类型的"),n("code",[s._v("Exchange")]),s._v("与"),n("code",[s._v("Direct")]),s._v("相比，都是可以根据"),n("code",[s._v("RoutingKey")]),s._v("把消息路由到不同的队列。只不过"),n("code",[s._v("Topic")]),s._v("类型"),n("code",[s._v("Exchange")]),s._v("可以让队列在绑定"),n("code",[s._v("Routing key")]),s._v(" 的时候使用通配符！")]),s._v(" "),n("p",[n("code",[s._v("Routingkey")]),s._v(" 一般都是有一个或多个单词组成，多个单词之间以”.”分割，例如： "),n("code",[s._v("item.insert")])]),s._v(" "),n("p",[s._v("通配符规则：")]),s._v(" "),n("p",[n("code",[s._v("#")]),s._v("：匹配一个或多个词")]),s._v(" "),n("p",[n("code",[s._v("*")]),s._v("：匹配不多不少恰好1个词")]),s._v(" "),n("p",[s._v("举例：")]),s._v(" "),n("p",[n("code",[s._v("item.#")]),s._v("：能够匹配"),n("code",[s._v("item.spu.insert")]),s._v(" 或者 "),n("code",[s._v("item.spu")])]),s._v(" "),n("p",[n("code",[s._v("item.*")]),s._v("：只能匹配"),n("code",[s._v("item.spu")])]),s._v(" "),n("p",[s._v("​")]),s._v(" "),n("p",[s._v("图示：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1212),alt:"image-20210717170705380"}})]),s._v(" "),n("p",[s._v("解释：")]),s._v(" "),n("ul",[n("li",[s._v("Queue1：绑定的是"),n("code",[s._v("china.#")]),s._v(" ，因此凡是以 "),n("code",[s._v("china.")]),s._v("开头的"),n("code",[s._v("routing key")]),s._v(" 都会被匹配到。包括china.news和china.weather")]),s._v(" "),n("li",[s._v("Queue2：绑定的是"),n("code",[s._v("#.news")]),s._v(" ，因此凡是以 "),n("code",[s._v(".news")]),s._v("结尾的 "),n("code",[s._v("routing key")]),s._v(" 都会被匹配。包括china.news和japan.news")])]),s._v(" "),n("p",[s._v("案例需求：")]),s._v(" "),n("p",[s._v("实现思路如下：")]),s._v(" "),n("ol",[n("li",[n("p",[s._v("并利用@RabbitListener声明Exchange、Queue、RoutingKey")])]),s._v(" "),n("li",[n("p",[s._v("在consumer服务中，编写两个消费者方法，分别监听topic.queue1和topic.queue2")])]),s._v(" "),n("li",[n("p",[s._v("在publisher中编写测试方法，向itcast. topic发送消息")])])]),s._v(" "),n("p",[n("img",{attrs:{src:a(1213),alt:"image-20210717170829229"}})]),s._v(" "),n("h3",{attrs:{id:"_3-6-2-消息发送"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-6-2-消息发送"}},[s._v("#")]),s._v(" 3.6.2.消息发送")]),s._v(" "),n("p",[s._v("在publisher服务的SpringAmqpTest类中添加测试方法：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n     * topicExchange\n     */")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Test")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("testSendTopicExchange")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 交换机名称")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" exchangeName "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"itcast.topic"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 消息")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" message "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"喜报！孙悟空大战哥斯拉，胜!"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 发送消息")]),s._v("\n    rabbitTemplate"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("convertAndSend")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("exchangeName"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"china.news"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" message"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("h3",{attrs:{id:"_3-6-3-消息接收"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-6-3-消息接收"}},[s._v("#")]),s._v(" 3.6.3.消息接收")]),s._v(" "),n("p",[s._v("在consumer服务的SpringRabbitListener中添加方法：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@RabbitListener")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bindings "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@QueueBinding")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    value "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Queue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"topic.queue1"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    exchange "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Exchange")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"itcast.topic"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" type "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ExchangeTypes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("TOPIC")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    key "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"china.#"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("listenTopicQueue1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" msg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"消费者接收到topic.queue1的消息：【"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" msg "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"】"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@RabbitListener")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bindings "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@QueueBinding")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    value "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Queue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"topic.queue2"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    exchange "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Exchange")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"itcast.topic"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" type "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ExchangeTypes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("TOPIC")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    key "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"#.news"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("listenTopicQueue2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" msg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"消费者接收到topic.queue2的消息：【"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" msg "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"】"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])]),n("h3",{attrs:{id:"_3-6-4-总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-6-4-总结"}},[s._v("#")]),s._v(" 3.6.4.总结")]),s._v(" "),n("p",[s._v("描述下Direct交换机与Topic交换机的差异？")]),s._v(" "),n("ul",[n("li",[s._v("Topic交换机接收的消息RoutingKey必须是多个单词，以 "),n("code",[s._v("**.**")]),s._v(" 分割")]),s._v(" "),n("li",[s._v("Topic交换机与队列绑定时的bindingKey可以指定通配符")]),s._v(" "),n("li",[n("code",[s._v("#")]),s._v("：代表0个或多个词")]),s._v(" "),n("li",[n("code",[s._v("*")]),s._v("：代表1个词")])]),s._v(" "),n("h2",{attrs:{id:"_3-7-消息转换器"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-7-消息转换器"}},[s._v("#")]),s._v(" 3.7.消息转换器")]),s._v(" "),n("p",[s._v("之前说过，Spring会把你发送的消息序列化为字节发送给MQ，接收消息的时候，还会把字节反序列化为Java对象。")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1214),alt:"image-20200525170410401"}})]),s._v(" "),n("p",[s._v("只不过，默认情况下Spring采用的序列化方式是JDK序列化。众所周知，JDK序列化存在下列问题：")]),s._v(" "),n("ul",[n("li",[s._v("数据体积过大")]),s._v(" "),n("li",[s._v("有安全漏洞")]),s._v(" "),n("li",[s._v("可读性差")])]),s._v(" "),n("p",[s._v("我们来测试一下。")]),s._v(" "),n("h3",{attrs:{id:"_3-7-1-测试默认转换器"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-7-1-测试默认转换器"}},[s._v("#")]),s._v(" 3.7.1.测试默认转换器")]),s._v(" "),n("p",[s._v("我们修改消息发送的代码，发送一个Map对象：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Test")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("testSendMap")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("InterruptedException")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 准备消息")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Map")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Object")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" msg "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("HashMap")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    msg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("put")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Jack"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    msg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("put")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"age"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 发送消息")]),s._v("\n    rabbitTemplate"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("convertAndSend")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"simple.queue"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" msg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("p",[s._v("停止consumer服务")]),s._v(" "),n("p",[s._v("发送消息后查看控制台：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1215),alt:"image-20210422232835363"}})]),s._v(" "),n("h3",{attrs:{id:"_3-7-2-配置json转换器"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-7-2-配置json转换器"}},[s._v("#")]),s._v(" 3.7.2.配置JSON转换器")]),s._v(" "),n("p",[s._v("显然，JDK序列化方式并不合适。我们希望消息体的体积更小、可读性更高，因此可以使用JSON方式来做序列化和反序列化。")]),s._v(" "),n("p",[s._v("在publisher和consumer两个服务中都引入依赖：")]),s._v(" "),n("div",{staticClass:"language-xml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-xml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("dependency")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("groupId")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("com.fasterxml.jackson.dataformat"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("groupId")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("artifactId")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("jackson-dataformat-xml"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("artifactId")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("version")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("2.9.10"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("version")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("dependency")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("配置消息转换器。")]),s._v(" "),n("p",[s._v("在启动类中添加一个Bean即可：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MessageConverter")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("jsonMessageConverter")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Jackson2JsonMessageConverter")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);