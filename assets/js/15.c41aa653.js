(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{1295:function(s,t,a){s.exports=a.p+"assets/img/image-20210718155003157.aa6a8e9e.png"},1296:function(s,t,a){s.exports=a.p+"assets/img/image-20210718155059371.5f2a526c.png"},1297:function(s,t,a){s.exports=a.p+"assets/img/image-20210718155328927.f0c4beab.png"},1298:function(s,t,a){s.exports=a.p+"assets/img/image-20210718155448734.ea30c97e.png"},1299:function(s,t,a){s.exports=a.p+"assets/img/image-20210718160907166.f051f8df.png"},1300:function(s,t,a){s.exports=a.p+"assets/img/image-20210718161707992.ec005511.png"},1301:function(s,t,a){s.exports=a.p+"assets/img/image-20210718164412450.998a7e87.png"},1302:function(s,t,a){s.exports=a.p+"assets/img/image-20210718164729543.983544a6.png"},1303:function(s,t,a){s.exports=a.p+"assets/img/image-20210718165100016.31d878c5.png"},1304:function(s,t,a){s.exports=a.p+"assets/img/image-20210718171705383.bb345970.png"},1305:function(s,t,a){s.exports=a.p+"assets/img/image-20210718171759179.d11c5f4d.png"},1306:function(s,t,a){s.exports=a.p+"assets/img/image-20210718172746378.594ac440.png"},1307:function(s,t,a){s.exports=a.p+"assets/img/image-20210718174328383.0506adc5.png"},1308:function(s,t,a){s.exports=a.p+"assets/img/image-20210718174416160.eb8f473d.png"},1309:function(s,t,a){s.exports=a.p+"assets/img/image-20210821073801398.233dfa07.png"},1310:function(s,t,a){s.exports=a.p+"assets/img/image-20210718182643311.25dd050f.png"},1311:function(s,t,a){s.exports=a.p+"assets/img/image-20210718191657478.72892ebc.png"},1312:function(s,t,a){s.exports=a.p+"assets/img/image-20210718191738706.d4b7f319.png"},1313:function(s,t,a){s.exports=a.p+"assets/img/image-20210718191939140.a7e27c97.png"},1314:function(s,t,a){s.exports=a.p+"assets/img/image-20210718192004662.05eae313.png"},1315:function(s,t,a){s.exports=a.p+"assets/img/image-20210718192529342.3e5e04e7.png"},1316:function(s,t,a){s.exports=a.p+"assets/img/image-20210718193409812.73022852.png"},1317:function(s,t,a){s.exports=a.p+"assets/img/image-20210718193747649.29204063.png"},1318:function(s,t,a){s.exports=a.p+"assets/img/image-20210718193831076.bac7453d.png"},1319:function(s,t,a){s.exports=a.p+"assets/img/image-20210718193917009.60d073cc.png"},1320:function(s,t,a){s.exports=a.p+"assets/img/image-20210718194040498.3286d5dd.png"},1321:function(s,t,a){s.exports=a.p+"assets/img/image-20210718194522223.83e9baef.png"},1322:function(s,t,a){s.exports=a.p+"assets/img/image-20210718194539054.401fafbb.png"},1323:function(s,t,a){s.exports=a.p+"assets/img/image-20210718220843323.ac75040e.png"},1324:function(s,t,a){s.exports=a.p+"assets/img/image-20210718221039542.fc2cc035.png"},1811:function(s,t,a){"use strict";a.r(t);var n=a(1),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"服务异步通信-高级篇"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#服务异步通信-高级篇"}},[s._v("#")]),s._v(" 服务异步通信-高级篇")]),s._v(" "),n("p",[s._v("消息队列在使用过程中，面临着很多实际问题需要思考：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1295),alt:"image-20210718155003157"}})]),s._v(" "),n("h1",{attrs:{id:"_1-消息可靠性"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-消息可靠性"}},[s._v("#")]),s._v(" 1.消息可靠性")]),s._v(" "),n("p",[s._v("消息从发送，到消费者接收，会经理多个过程：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1296),alt:"image-20210718155059371"}})]),s._v(" "),n("p",[s._v("其中的每一步都可能导致消息丢失，常见的丢失原因包括：")]),s._v(" "),n("ul",[n("li",[s._v("发送时丢失：\n"),n("ul",[n("li",[s._v("生产者发送的消息未送达exchange")]),s._v(" "),n("li",[s._v("消息到达exchange后未到达queue")])])]),s._v(" "),n("li",[s._v("MQ宕机，queue将消息丢失")]),s._v(" "),n("li",[s._v("consumer接收到消息后未消费就宕机")])]),s._v(" "),n("p",[s._v("针对这些问题，RabbitMQ分别给出了解决方案：")]),s._v(" "),n("ul",[n("li",[s._v("生产者确认机制")]),s._v(" "),n("li",[s._v("mq持久化")]),s._v(" "),n("li",[s._v("消费者确认机制")]),s._v(" "),n("li",[s._v("失败重试机制")])]),s._v(" "),n("p",[s._v("下面我们就通过案例来演示每一个步骤。")]),s._v(" "),n("p",[s._v("首先，导入课前资料提供的demo工程：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1297),alt:"image-20210718155328927"}})]),s._v(" "),n("p",[s._v("项目结构如下：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1298),alt:"image-20210718155448734"}})]),s._v(" "),n("h2",{attrs:{id:"_1-1-生产者消息确认"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-生产者消息确认"}},[s._v("#")]),s._v(" 1.1.生产者消息确认")]),s._v(" "),n("p",[s._v("RabbitMQ提供了publisher confirm机制来避免消息发送到MQ过程中丢失。这种机制必须给每个消息指定一个唯一ID。消息发送到MQ以后，会返回一个结果给发送者，表示消息是否处理成功。")]),s._v(" "),n("p",[s._v("返回结果有两种方式：")]),s._v(" "),n("ul",[n("li",[s._v("publisher-confirm，发送者确认\n"),n("ul",[n("li",[s._v("消息成功投递到交换机，返回ack")]),s._v(" "),n("li",[s._v("消息未投递到交换机，返回nack")])])]),s._v(" "),n("li",[s._v("publisher-return，发送者回执\n"),n("ul",[n("li",[s._v("消息投递到交换机了，但是没有路由到队列。返回ACK，及路由失败原因。")])])])]),s._v(" "),n("p",[n("img",{attrs:{src:a(1299),alt:"image-20210718160907166"}})]),s._v(" "),n("p",[s._v("注意：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1300),alt:"image-20210718161707992"}})]),s._v(" "),n("h3",{attrs:{id:"_1-1-1-修改配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-1-修改配置"}},[s._v("#")]),s._v(" 1.1.1.修改配置")]),s._v(" "),n("p",[s._v("首先，修改publisher服务中的application.yml文件，添加下面的内容：")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spring")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rabbitmq")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("publisher-confirm-type")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" correlated\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("publisher-returns")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mandatory")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n   \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("说明：")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("publish-confirm-type")]),s._v("：开启publisher-confirm，这里支持两种类型：\n"),n("ul",[n("li",[n("code",[s._v("simple")]),s._v("：同步等待confirm结果，直到超时")]),s._v(" "),n("li",[n("code",[s._v("correlated")]),s._v("：异步回调，定义ConfirmCallback，MQ返回结果时会回调这个ConfirmCallback")])])]),s._v(" "),n("li",[n("code",[s._v("publish-returns")]),s._v("：开启publish-return功能，同样是基于callback机制，不过是定义ReturnCallback")]),s._v(" "),n("li",[n("code",[s._v("template.mandatory")]),s._v("：定义消息路由失败时的策略。true，则调用ReturnCallback；false：则直接丢弃消息")])]),s._v(" "),n("h3",{attrs:{id:"_1-1-2-定义return回调"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-2-定义return回调"}},[s._v("#")]),s._v(" 1.1.2.定义Return回调")]),s._v(" "),n("p",[s._v("每个RabbitTemplate只能配置一个ReturnCallback，因此需要在项目加载时配置：")]),s._v(" "),n("p",[s._v("修改publisher服务，添加一个：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("package")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("cn"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("itcast"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mq"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("config")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("lombok"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("extern"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("slf4j"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Slf4j")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("amqp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rabbit"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("core"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RabbitTemplate")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("beans"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BeansException")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ApplicationContext")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ApplicationContextAware")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("annotation"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Configuration")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Slf4j")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Configuration")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("CommonConfig")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("implements")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ApplicationContextAware")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setApplicationContext")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ApplicationContext")]),s._v(" applicationContext"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BeansException")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 获取RabbitTemplate")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RabbitTemplate")]),s._v(" rabbitTemplate "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" applicationContext"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getBean")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RabbitTemplate")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 设置ReturnCallback")]),s._v("\n        rabbitTemplate"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setReturnCallback")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("message"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" replyCode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" replyText"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" exchange"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" routingKey"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 投递失败，记录日志")]),s._v("\n            log"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("info")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"消息发送失败，应答码{}，原因{}，交换机{}，路由键{},消息{}"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                     replyCode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" replyText"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" exchange"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" routingKey"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" message"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("toString")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 如果有业务需要，可以重发消息")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br")])]),n("h3",{attrs:{id:"_1-1-3-定义confirmcallback"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-3-定义confirmcallback"}},[s._v("#")]),s._v(" 1.1.3.定义ConfirmCallback")]),s._v(" "),n("p",[s._v("ConfirmCallback可以在发送消息时指定，因为每个业务处理confirm成功或失败的逻辑不一定相同。")]),s._v(" "),n("p",[s._v("在publisher服务的cn.itcast.mq.spring.SpringAmqpTest类中，定义一个单元测试方法：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("testSendMessage2SimpleQueue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("InterruptedException")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 1.消息体")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" message "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello, spring amqp!"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 2.全局唯一的消息ID，需要封装到CorrelationData中")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("CorrelationData")]),s._v(" correlationData "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("CorrelationData")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("UUID")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("randomUUID")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("toString")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 3.添加callback")]),s._v("\n    correlationData"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getFuture")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("addCallback")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n        result "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("result"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("isAck")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 3.1.ack，消息成功")]),s._v("\n                log"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("debug")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"消息发送成功, ID:{}"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" correlationData"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getId")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 3.2.nack，消息失败")]),s._v("\n                log"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"消息发送失败, ID:{}, 原因{}"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("correlationData"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getId")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" result"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getReason")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        ex "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v(" log"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"消息发送异常, ID:{}, 原因{}"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("correlationData"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getId")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("ex"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getMessage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 4.发送消息")]),s._v("\n    rabbitTemplate"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("convertAndSend")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"task.direct"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"task"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" message"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" correlationData"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 休眠一会儿，等待ack回执")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br")])]),n("h2",{attrs:{id:"_1-2-消息持久化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-消息持久化"}},[s._v("#")]),s._v(" 1.2.消息持久化")]),s._v(" "),n("p",[s._v("生产者确认可以确保消息投递到RabbitMQ的队列中，但是消息发送到RabbitMQ以后，如果突然宕机，也可能导致消息丢失。")]),s._v(" "),n("p",[s._v("要想确保消息在RabbitMQ中安全保存，必须开启消息持久化机制。")]),s._v(" "),n("ul",[n("li",[s._v("交换机持久化")]),s._v(" "),n("li",[s._v("队列持久化")]),s._v(" "),n("li",[s._v("消息持久化")])]),s._v(" "),n("h3",{attrs:{id:"_1-2-1-交换机持久化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-1-交换机持久化"}},[s._v("#")]),s._v(" 1.2.1.交换机持久化")]),s._v(" "),n("p",[s._v("RabbitMQ中交换机默认是非持久化的，mq重启后就丢失。")]),s._v(" "),n("p",[s._v("SpringAMQP中可以通过代码指定交换机持久化：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DirectExchange")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("simpleExchange")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 三个参数：交换机名称、是否持久化、当没有queue与其绑定时是否自动删除")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DirectExchange")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"simple.direct"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("事实上，默认情况下，由SpringAMQP声明的交换机都是持久化的。")]),s._v(" "),n("p",[s._v("可以在RabbitMQ控制台看到持久化的交换机都会带上"),n("code",[s._v("D")]),s._v("的标示：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1301),alt:"image-20210718164412450"}})]),s._v(" "),n("h3",{attrs:{id:"_1-2-2-队列持久化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-2-队列持久化"}},[s._v("#")]),s._v(" 1.2.2.队列持久化")]),s._v(" "),n("p",[s._v("RabbitMQ中队列默认是非持久化的，mq重启后就丢失。")]),s._v(" "),n("p",[s._v("SpringAMQP中可以通过代码指定交换机持久化：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Queue")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("simpleQueue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 使用QueueBuilder构建队列，durable就是持久化的")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("QueueBuilder")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("durable")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"simple.queue"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("build")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("事实上，默认情况下，由SpringAMQP声明的队列都是持久化的。")]),s._v(" "),n("p",[s._v("可以在RabbitMQ控制台看到持久化的队列都会带上"),n("code",[s._v("D")]),s._v("的标示：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1302),alt:"image-20210718164729543"}})]),s._v(" "),n("h3",{attrs:{id:"_1-2-3-消息持久化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-3-消息持久化"}},[s._v("#")]),s._v(" 1.2.3.消息持久化")]),s._v(" "),n("p",[s._v("利用SpringAMQP发送消息时，可以设置消息的属性（MessageProperties），指定delivery-mode：")]),s._v(" "),n("ul",[n("li",[s._v("1：非持久化")]),s._v(" "),n("li",[s._v("2：持久化")])]),s._v(" "),n("p",[s._v("用java代码指定：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1303),alt:"image-20210718165100016"}})]),s._v(" "),n("p",[s._v("默认情况下，SpringAMQP发出的任何消息都是持久化的，不用特意指定。")]),s._v(" "),n("h2",{attrs:{id:"_1-3-消费者消息确认"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-消费者消息确认"}},[s._v("#")]),s._v(" 1.3.消费者消息确认")]),s._v(" "),n("p",[s._v("RabbitMQ是"),n("strong",[s._v("阅后即焚")]),s._v("机制，RabbitMQ确认消息被消费者消费后会立刻删除。")]),s._v(" "),n("p",[s._v("而RabbitMQ是通过消费者回执来确认消费者是否成功处理消息的：消费者获取消息后，应该向RabbitMQ发送ACK回执，表明自己已经处理消息。")]),s._v(" "),n("p",[s._v("设想这样的场景：")]),s._v(" "),n("ul",[n("li",[s._v("1）RabbitMQ投递消息给消费者")]),s._v(" "),n("li",[s._v("2）消费者获取消息后，返回ACK给RabbitMQ")]),s._v(" "),n("li",[s._v("3）RabbitMQ删除消息")]),s._v(" "),n("li",[s._v("4）消费者宕机，消息尚未处理")])]),s._v(" "),n("p",[s._v("这样，消息就丢失了。因此消费者返回ACK的时机非常重要。")]),s._v(" "),n("p",[s._v("而SpringAMQP则允许配置三种确认模式：")]),s._v(" "),n("p",[s._v("•manual：手动ack，需要在业务代码结束后，调用api发送ack。")]),s._v(" "),n("p",[s._v("•auto：自动ack，由spring监测listener代码是否出现异常，没有异常则返回ack；抛出异常则返回nack")]),s._v(" "),n("p",[s._v("•none：关闭ack，MQ假定消费者获取消息后会成功处理，因此消息投递后立即被删除")]),s._v(" "),n("p",[s._v("由此可知：")]),s._v(" "),n("ul",[n("li",[s._v("none模式下，消息投递是不可靠的，可能丢失")]),s._v(" "),n("li",[s._v("auto模式类似事务机制，出现异常时返回nack，消息回滚到mq；没有异常，返回ack")]),s._v(" "),n("li",[s._v("manual：自己根据业务情况，判断什么时候该ack")])]),s._v(" "),n("p",[s._v("一般，我们都是使用默认的auto即可。")]),s._v(" "),n("h3",{attrs:{id:"_1-3-1-演示none模式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-1-演示none模式"}},[s._v("#")]),s._v(" 1.3.1.演示none模式")]),s._v(" "),n("p",[s._v("修改consumer服务的application.yml文件，添加下面内容：")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spring")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rabbitmq")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("listener")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("simple")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("acknowledge-mode")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" none "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 关闭ack")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("修改consumer服务的SpringRabbitListener类中的方法，模拟一个消息处理异常：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@RabbitListener")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("queues "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"simple.queue"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("listenSimpleQueue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" msg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    log"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("info")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"消费者接收到simple.queue的消息：【{}】"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" msg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 模拟异常")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    log"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("debug")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"消息处理完成！"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("测试可以发现，当消息处理抛异常时，消息依然被RabbitMQ删除了。")]),s._v(" "),n("h3",{attrs:{id:"_1-3-2-演示auto模式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-2-演示auto模式"}},[s._v("#")]),s._v(" 1.3.2.演示auto模式")]),s._v(" "),n("p",[s._v("再次把确认机制修改为auto:")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spring")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rabbitmq")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("listener")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("simple")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("acknowledge-mode")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" auto "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 关闭ack")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("在异常位置打断点，再次发送消息，程序卡在断点时，可以发现此时消息状态为unack（未确定状态）：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1304),alt:"image-20210718171705383"}})]),s._v(" "),n("p",[s._v("抛出异常后，因为Spring会自动返回nack，所以消息恢复至Ready状态，并且没有被RabbitMQ删除：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1305),alt:"image-20210718171759179"}})]),s._v(" "),n("h2",{attrs:{id:"_1-4-消费失败重试机制"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-消费失败重试机制"}},[s._v("#")]),s._v(" 1.4.消费失败重试机制")]),s._v(" "),n("p",[s._v("当消费者出现异常后，消息会不断requeue（重入队）到队列，再重新发送给消费者，然后再次异常，再次requeue，无限循环，导致mq的消息处理飙升，带来不必要的压力：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1306),alt:"image-20210718172746378"}})]),s._v(" "),n("p",[s._v("怎么办呢？")]),s._v(" "),n("h3",{attrs:{id:"_1-4-1-本地重试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-1-本地重试"}},[s._v("#")]),s._v(" 1.4.1.本地重试")]),s._v(" "),n("p",[s._v("我们可以利用Spring的retry机制，在消费者出现异常时利用本地重试，而不是无限制的requeue到mq队列。")]),s._v(" "),n("p",[s._v("修改consumer服务的application.yml文件，添加内容：")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spring")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rabbitmq")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("listener")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("simple")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("retry")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("enabled")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开启消费者失败重试")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("initial-interval")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 初识的失败等待时长为1秒")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("multiplier")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 失败的等待时长倍数，下次等待时长 = multiplier * last-interval")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("max-attempts")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 最大重试次数")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stateless")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# true无状态；false有状态。如果业务中包含事务，这里改为false")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("重启consumer服务，重复之前的测试。可以发现：")]),s._v(" "),n("ul",[n("li",[s._v("在重试3次后，SpringAMQP会抛出异常AmqpRejectAndDontRequeueException，说明本地重试触发了")]),s._v(" "),n("li",[s._v("查看RabbitMQ控制台，发现消息被删除了，说明最后SpringAMQP返回的是ack，mq删除消息了")])]),s._v(" "),n("p",[s._v("结论：")]),s._v(" "),n("ul",[n("li",[s._v("开启本地重试时，消息处理过程中抛出异常，不会requeue到队列，而是在消费者本地重试")]),s._v(" "),n("li",[s._v("重试达到最大次数后，Spring会返回ack，消息会被丢弃")])]),s._v(" "),n("h3",{attrs:{id:"_1-4-2-失败策略"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-2-失败策略"}},[s._v("#")]),s._v(" 1.4.2.失败策略")]),s._v(" "),n("p",[s._v("在之前的测试中，达到最大重试次数后，消息会被丢弃，这是由Spring内部机制决定的。")]),s._v(" "),n("p",[s._v("在开启重试模式后，重试次数耗尽，如果消息依然失败，则需要有MessageRecovery接口来处理，它包含三种不同的实现：")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("RejectAndDontRequeueRecoverer：重试耗尽后，直接reject，丢弃消息。默认就是这种方式")])]),s._v(" "),n("li",[n("p",[s._v("ImmediateRequeueMessageRecoverer：重试耗尽后，返回nack，消息重新入队")])]),s._v(" "),n("li",[n("p",[s._v("RepublishMessageRecoverer：重试耗尽后，将失败消息投递到指定的交换机")])])]),s._v(" "),n("p",[s._v("比较优雅的一种处理方案是RepublishMessageRecoverer，失败后将消息投递到一个指定的，专门存放异常消息的队列，后续由人工集中处理。")]),s._v(" "),n("p",[s._v("1）在consumer服务中定义处理失败消息的交换机和队列")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DirectExchange")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("errorMessageExchange")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DirectExchange")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"error.direct"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Queue")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("errorQueue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Queue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"error.queue"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Binding")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("errorBinding")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Queue")]),s._v(" errorQueue"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DirectExchange")]),s._v(" errorMessageExchange"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BindingBuilder")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("bind")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("errorQueue"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("errorMessageExchange"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("with")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"error"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[s._v("2）定义一个RepublishMessageRecoverer，关联队列和交换机")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MessageRecoverer")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("republishMessageRecoverer")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RabbitTemplate")]),s._v(" rabbitTemplate"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RepublishMessageRecoverer")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rabbitTemplate"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"error.direct"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"error"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("完整代码：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("package")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("cn"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("itcast"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mq"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("config")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("amqp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("core"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Binding")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("amqp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("core"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BindingBuilder")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("amqp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("core"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DirectExchange")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("amqp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("core"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Queue")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("amqp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rabbit"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("core"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RabbitTemplate")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("amqp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rabbit"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("retry"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MessageRecoverer")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("amqp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rabbit"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("retry"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RepublishMessageRecoverer")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token import"}},[n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("annotation"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Bean")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Configuration")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ErrorMessageConfig")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DirectExchange")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("errorMessageExchange")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DirectExchange")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"error.direct"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Queue")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("errorQueue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Queue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"error.queue"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Binding")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("errorBinding")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Queue")]),s._v(" errorQueue"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DirectExchange")]),s._v(" errorMessageExchange"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BindingBuilder")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("bind")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("errorQueue"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("errorMessageExchange"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("with")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"error"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MessageRecoverer")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("republishMessageRecoverer")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RabbitTemplate")]),s._v(" rabbitTemplate"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RepublishMessageRecoverer")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rabbitTemplate"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"error.direct"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"error"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br")])]),n("h2",{attrs:{id:"_1-5-总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-总结"}},[s._v("#")]),s._v(" 1.5.总结")]),s._v(" "),n("p",[s._v("如何确保RabbitMQ消息的可靠性？")]),s._v(" "),n("ul",[n("li",[s._v("开启生产者确认机制，确保生产者的消息能到达队列")]),s._v(" "),n("li",[s._v("开启持久化功能，确保消息未消费前在队列中不会丢失")]),s._v(" "),n("li",[s._v("开启消费者确认机制为auto，由spring确认消息处理成功后完成ack")]),s._v(" "),n("li",[s._v("开启消费者失败重试机制，并设置MessageRecoverer，多次重试失败后将消息投递到异常交换机，交由人工处理")])]),s._v(" "),n("h1",{attrs:{id:"_2-死信交换机"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-死信交换机"}},[s._v("#")]),s._v(" 2.死信交换机")]),s._v(" "),n("h2",{attrs:{id:"_2-1-初识死信交换机"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-初识死信交换机"}},[s._v("#")]),s._v(" 2.1.初识死信交换机")]),s._v(" "),n("h3",{attrs:{id:"_2-1-1-什么是死信交换机"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-1-什么是死信交换机"}},[s._v("#")]),s._v(" 2.1.1.什么是死信交换机")]),s._v(" "),n("p",[s._v("什么是死信？")]),s._v(" "),n("p",[s._v("当一个队列中的消息满足下列情况之一时，可以成为死信（dead letter）：")]),s._v(" "),n("ul",[n("li",[s._v("消费者使用basic.reject或 basic.nack声明消费失败，并且消息的requeue参数设置为false")]),s._v(" "),n("li",[s._v("消息是一个过期消息，超时无人消费")]),s._v(" "),n("li",[s._v("要投递的队列消息满了，无法投递")])]),s._v(" "),n("p",[s._v("如果这个包含死信的队列配置了"),n("code",[s._v("dead-letter-exchange")]),s._v("属性，指定了一个交换机，那么队列中的死信就会投递到这个交换机中，而这个交换机称为"),n("strong",[s._v("死信交换机")]),s._v("（Dead Letter Exchange，检查DLX）。")]),s._v(" "),n("p",[s._v("如图，一个消息被消费者拒绝了，变成了死信：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1307),alt:"image-20210718174328383"}})]),s._v(" "),n("p",[s._v("因为simple.queue绑定了死信交换机 dl.direct，因此死信会投递给这个交换机：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1308),alt:"image-20210718174416160"}})]),s._v(" "),n("p",[s._v("如果这个死信交换机也绑定了一个队列，则消息最终会进入这个存放死信的队列：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(377),alt:"image-20210718174506856"}})]),s._v(" "),n("p",[s._v("另外，队列将死信投递给死信交换机时，必须知道两个信息：")]),s._v(" "),n("ul",[n("li",[s._v("死信交换机名称")]),s._v(" "),n("li",[s._v("死信交换机与死信队列绑定的RoutingKey")])]),s._v(" "),n("p",[s._v("这样才能确保投递的消息能到达死信交换机，并且正确的路由到死信队列。")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1309),alt:"image-20210821073801398"}})]),s._v(" "),n("h3",{attrs:{id:"_2-1-2-利用死信交换机接收死信-拓展"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-2-利用死信交换机接收死信-拓展"}},[s._v("#")]),s._v(" 2.1.2.利用死信交换机接收死信（拓展）")]),s._v(" "),n("p",[s._v("在失败重试策略中，默认的RejectAndDontRequeueRecoverer会在本地重试次数耗尽后，发送reject给RabbitMQ，消息变成死信，被丢弃。")]),s._v(" "),n("p",[s._v("我们可以给simple.queue添加一个死信交换机，给死信交换机绑定一个队列。这样消息变成死信后也不会丢弃，而是最终投递到死信交换机，路由到与死信交换机绑定的队列。")]),s._v(" "),n("p",[n("img",{attrs:{src:a(377),alt:"image-20210718174506856"}})]),s._v(" "),n("p",[s._v("我们在consumer服务中，定义一组死信交换机、死信队列：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 声明普通的 simple.queue队列，并且为其指定死信交换机：dl.direct")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Queue")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("simpleQueue2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("QueueBuilder")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("durable")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"simple.queue"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 指定队列名称，并持久化")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("deadLetterExchange")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dl.direct"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 指定死信交换机")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("build")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 声明死信交换机 dl.direct")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DirectExchange")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("dlExchange")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DirectExchange")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dl.direct"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 声明存储死信的队列 dl.queue")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Queue")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("dlQueue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Queue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dl.queue"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 将死信队列 与 死信交换机绑定")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Binding")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("dlBinding")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BindingBuilder")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("bind")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("dlQueue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("dlExchange")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("with")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"simple"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br")])]),n("h3",{attrs:{id:"_2-1-3-总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-3-总结"}},[s._v("#")]),s._v(" 2.1.3.总结")]),s._v(" "),n("p",[s._v("什么样的消息会成为死信？")]),s._v(" "),n("ul",[n("li",[s._v("消息被消费者reject或者返回nack")]),s._v(" "),n("li",[s._v("消息超时未消费")]),s._v(" "),n("li",[s._v("队列满了")])]),s._v(" "),n("p",[s._v("死信交换机的使用场景是什么？")]),s._v(" "),n("ul",[n("li",[s._v("如果队列绑定了死信交换机，死信会投递到死信交换机；")]),s._v(" "),n("li",[s._v("可以利用死信交换机收集所有消费者处理失败的消息（死信），交由人工处理，进一步提高消息队列的可靠性。")])]),s._v(" "),n("h2",{attrs:{id:"_2-2-ttl"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-ttl"}},[s._v("#")]),s._v(" 2.2.TTL")]),s._v(" "),n("p",[s._v("一个队列中的消息如果超时未消费，则会变为死信，超时分为两种情况：")]),s._v(" "),n("ul",[n("li",[s._v("消息所在的队列设置了超时时间")]),s._v(" "),n("li",[s._v("消息本身设置了超时时间")])]),s._v(" "),n("p",[n("img",{attrs:{src:a(1310),alt:"image-20210718182643311"}})]),s._v(" "),n("h3",{attrs:{id:"_2-2-1-接收超时死信的死信交换机"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-1-接收超时死信的死信交换机"}},[s._v("#")]),s._v(" 2.2.1.接收超时死信的死信交换机")]),s._v(" "),n("p",[s._v("在consumer服务的SpringRabbitListener中，定义一个新的消费者，并且声明 死信交换机、死信队列：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@RabbitListener")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bindings "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@QueueBinding")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    value "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Queue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dl.ttl.queue"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" durable "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    exchange "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Exchange")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dl.ttl.direct"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    key "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ttl"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("listenDlQueue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" msg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    log"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("info")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"接收到 dl.ttl.queue的延迟消息：{}"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" msg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("h3",{attrs:{id:"_2-2-2-声明一个队列-并且指定ttl"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-2-声明一个队列-并且指定ttl"}},[s._v("#")]),s._v(" 2.2.2.声明一个队列，并且指定TTL")]),s._v(" "),n("p",[s._v("要给队列设置超时时间，需要在声明队列时配置x-message-ttl属性：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Queue")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ttlQueue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("QueueBuilder")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("durable")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ttl.queue"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 指定队列名称，并持久化")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ttl")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 设置队列的超时时间，10秒")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("deadLetterExchange")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dl.ttl.direct"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 指定死信交换机")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("build")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("注意，这个队列设定了死信交换机为"),n("code",[s._v("dl.ttl.direct")])]),s._v(" "),n("p",[s._v("声明交换机，将ttl与交换机绑定：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DirectExchange")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ttlExchange")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DirectExchange")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ttl.direct"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Binding")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ttlBinding")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BindingBuilder")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("bind")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ttlQueue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ttlExchange")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("with")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ttl"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("发送消息，但是不要指定TTL：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Test")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("testTTLQueue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 创建消息")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" message "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello, ttl queue"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 消息ID，需要封装到CorrelationData中")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("CorrelationData")]),s._v(" correlationData "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("CorrelationData")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("UUID")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("randomUUID")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("toString")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 发送消息")]),s._v("\n    rabbitTemplate"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("convertAndSend")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ttl.direct"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ttl"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" message"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" correlationData"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 记录日志")]),s._v("\n    log"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("debug")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"发送消息成功"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[s._v("发送消息的日志：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1311),alt:"image-20210718191657478"}})]),s._v(" "),n("p",[s._v("查看下接收消息的日志：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1312),alt:"image-20210718191738706"}})]),s._v(" "),n("p",[s._v("因为队列的TTL值是10000ms，也就是10秒。可以看到消息发送与接收之间的时差刚好是10秒。")]),s._v(" "),n("h3",{attrs:{id:"_2-2-3-发送消息时-设定ttl"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-3-发送消息时-设定ttl"}},[s._v("#")]),s._v(" 2.2.3.发送消息时，设定TTL")]),s._v(" "),n("p",[s._v("在发送消息时，也可以指定TTL：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Test")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("testTTLMsg")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 创建消息")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Message")]),s._v(" message "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MessageBuilder")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("withBody")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello, ttl message"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getBytes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("StandardCharsets")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("UTF_8")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setExpiration")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5000"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("build")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 消息ID，需要封装到CorrelationData中")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("CorrelationData")]),s._v(" correlationData "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("CorrelationData")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("UUID")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("randomUUID")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("toString")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 发送消息")]),s._v("\n    rabbitTemplate"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("convertAndSend")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ttl.direct"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ttl"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" message"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" correlationData"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    log"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("debug")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"发送消息成功"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])]),n("p",[s._v("查看发送消息日志：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1313),alt:"image-20210718191939140"}})]),s._v(" "),n("p",[s._v("接收消息日志：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1314),alt:"image-20210718192004662"}})]),s._v(" "),n("p",[s._v("这次，发送与接收的延迟只有5秒。说明当队列、消息都设置了TTL时，任意一个到期就会成为死信。")]),s._v(" "),n("h3",{attrs:{id:"_2-2-4-总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-4-总结"}},[s._v("#")]),s._v(" 2.2.4.总结")]),s._v(" "),n("p",[s._v("消息超时的两种方式是？")]),s._v(" "),n("ul",[n("li",[s._v("给队列设置ttl属性，进入队列后超过ttl时间的消息变为死信")]),s._v(" "),n("li",[s._v("给消息设置ttl属性，队列接收到消息超过ttl时间后变为死信")])]),s._v(" "),n("p",[s._v("如何实现发送一个消息20秒后消费者才收到消息？")]),s._v(" "),n("ul",[n("li",[s._v("给消息的目标队列指定死信交换机")]),s._v(" "),n("li",[s._v("将消费者监听的队列绑定到死信交换机")]),s._v(" "),n("li",[s._v("发送消息时给消息设置超时时间为20秒")])]),s._v(" "),n("h2",{attrs:{id:"_2-3-延迟队列"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-延迟队列"}},[s._v("#")]),s._v(" 2.3.延迟队列")]),s._v(" "),n("p",[s._v("利用TTL结合死信交换机，我们实现了消息发出后，消费者延迟收到消息的效果。这种消息模式就称为延迟队列（Delay Queue）模式。")]),s._v(" "),n("p",[s._v("延迟队列的使用场景包括：")]),s._v(" "),n("ul",[n("li",[s._v("延迟发送短信")]),s._v(" "),n("li",[s._v("用户下单，如果用户在15 分钟内未支付，则自动取消")]),s._v(" "),n("li",[s._v("预约工作会议，20分钟后自动通知所有参会人员")])]),s._v(" "),n("p",[s._v("因为延迟队列的需求非常多，所以RabbitMQ的官方也推出了一个插件，原生支持延迟队列效果。")]),s._v(" "),n("p",[s._v("这个插件就是DelayExchange插件。参考RabbitMQ的插件列表页面：https://www.rabbitmq.com/community-plugins.html")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1315),alt:"image-20210718192529342"}})]),s._v(" "),n("p",[s._v("使用方式可以参考官网地址：https://blog.rabbitmq.com/posts/2015/04/scheduling-messages-with-rabbitmq")]),s._v(" "),n("h3",{attrs:{id:"_2-3-1-安装delayexchange插件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-1-安装delayexchange插件"}},[s._v("#")]),s._v(" 2.3.1.安装DelayExchange插件")]),s._v(" "),n("p",[s._v("参考课前资料：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1316),alt:"image-20210718193409812"}})]),s._v(" "),n("h3",{attrs:{id:"_2-3-2-delayexchange原理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-2-delayexchange原理"}},[s._v("#")]),s._v(" 2.3.2.DelayExchange原理")]),s._v(" "),n("p",[s._v("DelayExchange需要将一个交换机声明为delayed类型。当我们发送消息到delayExchange时，流程如下：")]),s._v(" "),n("ul",[n("li",[s._v("接收消息")]),s._v(" "),n("li",[s._v("判断消息是否具备x-delay属性")]),s._v(" "),n("li",[s._v("如果有x-delay属性，说明是延迟消息，持久化到硬盘，读取x-delay值，作为延迟时间")]),s._v(" "),n("li",[s._v("返回routing not found结果给消息发送者")]),s._v(" "),n("li",[s._v("x-delay时间到期后，重新投递消息到指定队列")])]),s._v(" "),n("h3",{attrs:{id:"_2-3-3-使用delayexchange"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-3-使用delayexchange"}},[s._v("#")]),s._v(" 2.3.3.使用DelayExchange")]),s._v(" "),n("p",[s._v("插件的使用也非常简单：声明一个交换机，交换机的类型可以是任意类型，只需要设定delayed属性为true即可，然后声明队列与其绑定即可。")]),s._v(" "),n("h4",{attrs:{id:"_1-声明delayexchange交换机"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-声明delayexchange交换机"}},[s._v("#")]),s._v(" 1）声明DelayExchange交换机")]),s._v(" "),n("p",[s._v("基于注解方式（推荐）：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1317),alt:"image-20210718193747649"}})]),s._v(" "),n("p",[s._v("也可以基于@Bean的方式：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1318),alt:"image-20210718193831076"}})]),s._v(" "),n("h4",{attrs:{id:"_2-发送消息"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-发送消息"}},[s._v("#")]),s._v(" 2）发送消息")]),s._v(" "),n("p",[s._v("发送消息时，一定要携带x-delay属性，指定延迟的时间：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1319),alt:"image-20210718193917009"}})]),s._v(" "),n("h3",{attrs:{id:"_2-3-4-总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-4-总结"}},[s._v("#")]),s._v(" 2.3.4.总结")]),s._v(" "),n("p",[s._v("延迟队列插件的使用步骤包括哪些？")]),s._v(" "),n("p",[s._v("•声明一个交换机，添加delayed属性为true")]),s._v(" "),n("p",[s._v("•发送消息时，添加x-delay头，值为超时时间")]),s._v(" "),n("h1",{attrs:{id:"_3-惰性队列"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-惰性队列"}},[s._v("#")]),s._v(" 3.惰性队列")]),s._v(" "),n("h2",{attrs:{id:"_3-1-消息堆积问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-消息堆积问题"}},[s._v("#")]),s._v(" 3.1.消息堆积问题")]),s._v(" "),n("p",[s._v("当生产者发送消息的速度超过了消费者处理消息的速度，就会导致队列中的消息堆积，直到队列存储消息达到上限。之后发送的消息就会成为死信，可能会被丢弃，这就是消息堆积问题。")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1320),alt:"image-20210718194040498"}})]),s._v(" "),n("p",[s._v("解决消息堆积有两种思路：")]),s._v(" "),n("ul",[n("li",[s._v("增加更多消费者，提高消费速度。也就是我们之前说的work queue模式")]),s._v(" "),n("li",[s._v("扩大队列容积，提高堆积上限")])]),s._v(" "),n("p",[s._v("要提升队列容积，把消息保存在内存中显然是不行的。")]),s._v(" "),n("h2",{attrs:{id:"_3-2-惰性队列"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-惰性队列"}},[s._v("#")]),s._v(" 3.2.惰性队列")]),s._v(" "),n("p",[s._v("从RabbitMQ的3.6.0版本开始，就增加了Lazy Queues的概念，也就是惰性队列。惰性队列的特征如下：")]),s._v(" "),n("ul",[n("li",[s._v("接收到消息后直接存入磁盘而非内存")]),s._v(" "),n("li",[s._v("消费者要消费消息时才会从磁盘中读取并加载到内存")]),s._v(" "),n("li",[s._v("支持数百万条的消息存储")])]),s._v(" "),n("h3",{attrs:{id:"_3-2-1-基于命令行设置lazy-queue"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-1-基于命令行设置lazy-queue"}},[s._v("#")]),s._v(" 3.2.1.基于命令行设置lazy-queue")]),s._v(" "),n("p",[s._v("而要设置一个队列为惰性队列，只需要在声明队列时，指定x-queue-mode属性为lazy即可。可以通过命令行将一个运行中的队列修改为惰性队列：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("rabbitmqctl set_policy Lazy "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"^lazy-queue$"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{"queue-mode":"lazy"}\'')]),s._v(" --apply-to queues  \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("命令解读：")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("rabbitmqctl")]),s._v(" ：RabbitMQ的命令行工具")]),s._v(" "),n("li",[n("code",[s._v("set_policy")]),s._v(" ：添加一个策略")]),s._v(" "),n("li",[n("code",[s._v("Lazy")]),s._v(" ：策略名称，可以自定义")]),s._v(" "),n("li",[n("code",[s._v('"^lazy-queue$"')]),s._v(" ：用正则表达式匹配队列的名字")]),s._v(" "),n("li",[n("code",[s._v('\'{"queue-mode":"lazy"}\'')]),s._v(" ：设置队列模式为lazy模式")]),s._v(" "),n("li",[n("code",[s._v("--apply-to queues")]),s._v("：策略的作用对象，是所有的队列")])]),s._v(" "),n("h3",{attrs:{id:"_3-2-2-基于-bean声明lazy-queue"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-2-基于-bean声明lazy-queue"}},[s._v("#")]),s._v(" 3.2.2.基于@Bean声明lazy-queue")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1321),alt:"image-20210718194522223"}})]),s._v(" "),n("h3",{attrs:{id:"_3-2-3-基于-rabbitlistener声明lazyqueue"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-3-基于-rabbitlistener声明lazyqueue"}},[s._v("#")]),s._v(" 3.2.3.基于@RabbitListener声明LazyQueue")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1322),alt:"image-20210718194539054"}})]),s._v(" "),n("h3",{attrs:{id:"_3-3-总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-总结"}},[s._v("#")]),s._v(" 3.3.总结")]),s._v(" "),n("p",[s._v("消息堆积问题的解决方案？")]),s._v(" "),n("ul",[n("li",[s._v("队列上绑定多个消费者，提高消费速度")]),s._v(" "),n("li",[s._v("使用惰性队列，可以再mq中保存更多消息")])]),s._v(" "),n("p",[s._v("惰性队列的优点有哪些？")]),s._v(" "),n("ul",[n("li",[s._v("基于磁盘存储，消息上限高")]),s._v(" "),n("li",[s._v("没有间歇性的page-out，性能比较稳定")])]),s._v(" "),n("p",[s._v("惰性队列的缺点有哪些？")]),s._v(" "),n("ul",[n("li",[s._v("基于磁盘存储，消息时效性会降低")]),s._v(" "),n("li",[s._v("性能受限于磁盘的IO")])]),s._v(" "),n("h1",{attrs:{id:"_4-mq集群"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-mq集群"}},[s._v("#")]),s._v(" 4.MQ集群")]),s._v(" "),n("h2",{attrs:{id:"_4-1-集群分类"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-集群分类"}},[s._v("#")]),s._v(" 4.1.集群分类")]),s._v(" "),n("p",[s._v("RabbitMQ的是基于Erlang语言编写，而Erlang又是一个面向并发的语言，天然支持集群模式。RabbitMQ的集群有两种模式：")]),s._v(" "),n("p",[s._v("•"),n("strong",[s._v("普通集群")]),s._v("：是一种分布式集群，将队列分散到集群的各个节点，从而提高整个集群的并发能力。")]),s._v(" "),n("p",[s._v("•"),n("strong",[s._v("镜像集群")]),s._v("：是一种主从集群，普通集群的基础上，添加了主从备份功能，提高集群的数据可用性。")]),s._v(" "),n("p",[s._v("镜像集群虽然支持主从，但主从同步并不是强一致的，某些情况下可能有数据丢失的风险。因此在RabbitMQ的3.8版本以后，推出了新的功能："),n("strong",[s._v("仲裁队列")]),s._v("来代替镜像集群，底层采用Raft协议确保主从的数据一致性。")]),s._v(" "),n("h2",{attrs:{id:"_4-2-普通集群"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-普通集群"}},[s._v("#")]),s._v(" 4.2.普通集群")]),s._v(" "),n("h3",{attrs:{id:"_4-2-1-集群结构和特征"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-1-集群结构和特征"}},[s._v("#")]),s._v(" 4.2.1.集群结构和特征")]),s._v(" "),n("p",[s._v("普通集群，或者叫标准集群（classic cluster），具备下列特征：")]),s._v(" "),n("ul",[n("li",[s._v("会在集群的各个节点间共享部分数据，包括：交换机、队列元信息。不包含队列中的消息。")]),s._v(" "),n("li",[s._v("当访问集群某节点时，如果队列不在该节点，会从数据所在节点传递到当前节点并返回")]),s._v(" "),n("li",[s._v("队列所在节点宕机，队列中的消息就会丢失")])]),s._v(" "),n("p",[s._v("结构如图：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1323),alt:"image-20210718220843323"}})]),s._v(" "),n("h3",{attrs:{id:"_4-2-2-部署"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-2-部署"}},[s._v("#")]),s._v(" 4.2.2.部署")]),s._v(" "),n("p",[s._v("参考课前资料：《RabbitMQ部署指南.md》")]),s._v(" "),n("h2",{attrs:{id:"_4-3-镜像集群"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-镜像集群"}},[s._v("#")]),s._v(" 4.3.镜像集群")]),s._v(" "),n("h3",{attrs:{id:"_4-3-1-集群结构和特征"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-1-集群结构和特征"}},[s._v("#")]),s._v(" 4.3.1.集群结构和特征")]),s._v(" "),n("p",[s._v("镜像集群：本质是主从模式，具备下面的特征：")]),s._v(" "),n("ul",[n("li",[s._v("交换机、队列、队列中的消息会在各个mq的镜像节点之间同步备份。")]),s._v(" "),n("li",[s._v("创建队列的节点被称为该队列的"),n("strong",[s._v("主节点，"),n("strong",[s._v("备份到的其它节点叫做该队列的")]),s._v("镜像")]),s._v("节点。")]),s._v(" "),n("li",[s._v("一个队列的主节点可能是另一个队列的镜像节点")]),s._v(" "),n("li",[s._v("所有操作都是主节点完成，然后同步给镜像节点")]),s._v(" "),n("li",[s._v("主宕机后，镜像节点会替代成新的主")])]),s._v(" "),n("p",[s._v("结构如图：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1324),alt:"image-20210718221039542"}})]),s._v(" "),n("h3",{attrs:{id:"_4-3-2-部署"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-2-部署"}},[s._v("#")]),s._v(" 4.3.2.部署")]),s._v(" "),n("p",[s._v("参考课前资料：《RabbitMQ部署指南.md》")]),s._v(" "),n("h2",{attrs:{id:"_4-4-仲裁队列"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-仲裁队列"}},[s._v("#")]),s._v(" 4.4.仲裁队列")]),s._v(" "),n("h3",{attrs:{id:"_4-4-1-集群特征"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-1-集群特征"}},[s._v("#")]),s._v(" 4.4.1.集群特征")]),s._v(" "),n("p",[s._v("仲裁队列：仲裁队列是3.8版本以后才有的新功能，用来替代镜像队列，具备下列特征：")]),s._v(" "),n("ul",[n("li",[s._v("与镜像队列一样，都是主从模式，支持主从数据同步")]),s._v(" "),n("li",[s._v("使用非常简单，没有复杂的配置")]),s._v(" "),n("li",[s._v("主从同步基于Raft协议，强一致")])]),s._v(" "),n("h3",{attrs:{id:"_4-4-2-部署"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-2-部署"}},[s._v("#")]),s._v(" 4.4.2.部署")]),s._v(" "),n("p",[s._v("参考课前资料：《RabbitMQ部署指南.md》")]),s._v(" "),n("h3",{attrs:{id:"_4-4-3-java代码创建仲裁队列"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-3-java代码创建仲裁队列"}},[s._v("#")]),s._v(" 4.4.3.Java代码创建仲裁队列")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Queue")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("quorumQueue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("QueueBuilder")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("durable")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"quorum.queue"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 持久化")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("quorum")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 仲裁队列")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("build")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("h3",{attrs:{id:"_4-4-4-springamqp连接mq集群"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-4-springamqp连接mq集群"}},[s._v("#")]),s._v(" 4.4.4.SpringAMQP连接MQ集群")]),s._v(" "),n("p",[s._v("注意，这里用address来代替host、port方式")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[s._v("spring"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n  rabbitmq"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n    addresses"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".150")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".105")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8071")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".150")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".105")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8072")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".150")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".105")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8073")]),s._v("\n    username"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" itcast\n    password"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("123321")]),s._v("\n    virtual"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("host"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])])])}),[],!1,null,null,null);t.default=e.exports},377:function(s,t,a){s.exports=a.p+"assets/img/image-20210718174506856.d0ea2199.png"}}]);